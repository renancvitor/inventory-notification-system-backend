name: CD - Deploy to EC2

on:
  workflow_run:
    workflows: ["CI - Build & Test"]
    types:
      - completed

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 21

      # ============================
      # ðŸ”¥ FLYWAY MIGRATION
      # ============================
      - name: Run Flyway migrations
        run: |
          mvn -q \
            -Dflyway.url=${{ secrets.DB_FLYWAY_URL }} \
            -Dflyway.user=${{ secrets.DB_USER }} \
            -Dflyway.password=${{ secrets.DB_PASSWORD }} \
            flyway:migrate

      # ============================
      # BUILD
      # ============================
      - name: Build JAR
        run: mvn clean package -DskipTests

      # ============================
      # SSH CONFIG
      # ============================
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          printf "%s\n" "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/ec2.pem
          chmod 600 ~/.ssh/ec2.pem
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      # ============================
      # DEPLOY
      # ============================
      - name: Deploy JAR
        run: |
          scp -i ~/.ssh/ec2.pem \
          target/*SNAPSHOT.jar \
          ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:${{ secrets.EC2_APP_DIR }}/app.jar

      # ============================
      # RESTART
      # ============================
      - name: Restart service
        run: |
          ssh -i ~/.ssh/ec2.pem \
          ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} \
          "sudo systemctl restart ${{ secrets.SERVICE_NAME }}"
