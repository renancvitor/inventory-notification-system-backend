name: CD - Deploy to EC2

on:
  workflow_run:
    workflows: ["CI - Build & Test"]
    types:
      - completed
  workflow_dispatch:  # Permite execu√ß√£o manual via GitHub UI ou gh CLI

jobs:
  deploy:
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    permissions:
      deployments: write
      contents: read

    steps:
      # ============================
      # üìä GITHUB DEPLOYMENT TRACKING
      # ============================
      - name: Create deployment
        uses: actions/github-script@v7
        with:
          script: |
            const deployment = await github.rest.repos.createDeployment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.ref,
              environment: 'production',
              required_contexts: [],
              auto_merge: false,
            });
            console.log('Deployment created with ID: ' + deployment.data.id);
            require('fs').appendFileSync(process.env.GITHUB_ENV, `DEPLOYMENT_ID=${deployment.data.id}\n`);

      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 21

      # ============================
      # üî• FLYWAY MIGRATION
      # ============================
      - name: Run Flyway migrations
        run: |
          mvn -q \
            -Dflyway.url=${{ secrets.DB_FLYWAY_URL }} \
            -Dflyway.user=${{ secrets.DB_USER }} \
            -Dflyway.password=${{ secrets.DB_PASSWORD }} \
            flyway:migrate

      # ============================
      # BUILD
      # ============================
      - name: Build JAR
        run: mvn clean package -DskipTests

      - name: Verify JAR was created
        run: |
          if [ ! -f target/inventory-notification-system-backend-0.0.1-SNAPSHOT.jar ]; then
            echo "‚ùå JAR file not found!"
            exit 1
          fi
          echo "‚úÖ JAR file created successfully"
          ls -lh target/inventory-notification-system-backend-0.0.1-SNAPSHOT.jar

      # ============================
      # SSH CONFIG
      # ============================
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          printf "%s\n" "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/ec2.pem
          chmod 600 ~/.ssh/ec2.pem
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Network test
        run: |
          echo "Testing connection to ${{ secrets.EC2_HOST }}"
          nc -zv ${{ secrets.EC2_HOST }} 22

      # ============================
      # PRE-DEPLOY CHECKS
      # ============================
      - name: Check EC2 connectivity and service status
        run: |
          ssh -i ~/.ssh/ec2.pem \
          ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} \
          "echo '‚úÖ Connected to EC2' && \
           echo 'üì¶ Current JAR:' && \
           ls -lh ${{ secrets.EC2_APP_DIR }}/inventory-notification-system-backend-0.0.1-SNAPSHOT.jar 2>/dev/null || echo 'No JAR found yet' && \
           echo 'üîç Service status:' && \
           sudo systemctl status ${{ secrets.SERVICE_NAME }} | head -5"

      # ============================
      # DEPLOY
      # ============================
      - name: Backup old JAR
        run: |
          ssh -i ~/.ssh/ec2.pem \
          ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} \
          "if [ -f ${{ secrets.EC2_APP_DIR }}/inventory-notification-system-backend-0.0.1-SNAPSHOT.jar ]; then \
             mv ${{ secrets.EC2_APP_DIR }}/inventory-notification-system-backend-0.0.1-SNAPSHOT.jar \
                ${{ secrets.EC2_APP_DIR }}/inventory-notification-system-backend-0.0.1-SNAPSHOT.jar.backup; \
             echo '‚úÖ Backup created'; \
           fi"

      - name: Deploy JAR to EC2
        run: |
          scp -i ~/.ssh/ec2.pem \
          target/inventory-notification-system-backend-0.0.1-SNAPSHOT.jar \
          ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:${{ secrets.EC2_APP_DIR }}/
          
          if [ $? -eq 0 ]; then
            echo "‚úÖ JAR deployed successfully"
          else
            echo "‚ùå Failed to deploy JAR"
            exit 1
          fi

      - name: Verify deployed JAR
        run: |
          ssh -i ~/.ssh/ec2.pem \
          ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} \
          "ls -lh ${{ secrets.EC2_APP_DIR }}/inventory-notification-system-backend-0.0.1-SNAPSHOT.jar && \
           echo '‚úÖ JAR verified on EC2'"

      # ============================
      # RESTART
      # ============================
      - name: Restart service
        run: |
          ssh -i ~/.ssh/ec2.pem \
          ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} \
          "echo 'Stopping service...' && \
           sudo systemctl stop ${{ secrets.SERVICE_NAME }} && \
           sleep 3 && \
           echo 'Starting service...' && \
           sudo systemctl start ${{ secrets.SERVICE_NAME }} && \
           sleep 5 && \
           echo 'Service status:' && \
           sudo systemctl status ${{ secrets.SERVICE_NAME }} --no-pager"

      - name: Verify service is running
        run: |
          ssh -i ~/.ssh/ec2.pem \
          ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} \
          "if sudo systemctl is-active --quiet ${{ secrets.SERVICE_NAME }}; then \
             echo '‚úÖ Service is running'; \
           else \
             echo '‚ùå Service failed to start'; \
             sudo systemctl status ${{ secrets.SERVICE_NAME }} --no-pager; \
             exit 1; \
           fi"

      - name: Health check
        run: |
          sleep 10
          echo "Checking health endpoint..."
          curl -s http://${{ secrets.EC2_HOST }}:8080/health | head -c 200 || echo "‚ö†Ô∏è Health check not yet available"

      # ============================
      # ‚úÖ DEPLOYMENT SUCCESS/FAILURE
      # ============================
      - name: Mark deployment as successful
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: process.env.DEPLOYMENT_ID,
              state: 'success',
              environment_url: 'http://${{ secrets.EC2_HOST }}:8080',
              description: 'Deployment completed successfully',
            });
            console.log('‚úÖ Deployment marked as successful');

      - name: Mark deployment as failed
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            if (process.env.DEPLOYMENT_ID) {
              await github.rest.repos.createDeploymentStatus({
                owner: context.repo.owner,
                repo: context.repo.repo,
                deployment_id: process.env.DEPLOYMENT_ID,
                state: 'failure',
                description: 'Deployment failed',
              });
              console.log('‚ùå Deployment marked as failed');
            } else {
              console.log('‚ö†Ô∏è DEPLOYMENT_ID not available');
            }
